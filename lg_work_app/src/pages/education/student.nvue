<template>
  <tm-app ref="app" color="grey-5">
    <tm-navbar title="å­¦å‘˜ç®¡ç†" :shadow="0" hide-home :followTheme="true">
      <template v-slot:right>
        <view class="flex flex-center flex-row">
          <tm-icon _class="px-24" :font-size="32" name="tmicon-menu" @click="showWin = true"></tm-icon>
        </view>
      </template>
    </tm-navbar>
    <tm-card v-for="(student, index) in data_source.data" :key="index" :status="data_source.grade.name"
      :statusColor="store.tmStore.color" :title="student.name">
      <template v-slot:content>
        <tm-sheet no-level :shadow="2" :round="3" :margin="[0, 0]">
          <tm-more :height="200">
            <tm-text :label="student.remind"></tm-text>
          </tm-more>
        </tm-sheet>
        <view class="flex flex-row flex-row-center-end">
          <tm-button label="å‘é€æé†’" :font-size="24" :width="120" :height="50" @click="copy(student.remind)"></tm-button>
          <tm-button :margin="[24, 0]" label="ç¼–è¾‘" :font-size="24" :width="120" :height="50"></tm-button>
          <tm-button color="white" label="åˆ é™¤" :font-size="24" :width="120" :height="50"></tm-button>
        </view>
      </template>
    </tm-card>
    <tm-drawer ref="gradeDrawer" placement="right" v-model:show="showWin">
      <template v-slot:default>
        <tm-sheet>
          <tm-text :font-size="24" _class="font-weight-b" label="æˆ‘çš„ç­çº§"></tm-text>
          <tm-divider></tm-divider>
          <tm-radio-group model="button" v-model="select_grade">
            <tm-radio :border="0" :round="3" v-for="(grade, index) in grade_source.data" :key="index" :value="grade.id"
              :label="grade.name" :fontSize="30" @change="selectGrade(grade)"></tm-radio>
          </tm-radio-group>
        </tm-sheet>
      </template>
    </tm-drawer>
    <tm-result v-if="data_source.data.length <= 0" :showBtn="false" title="æ•°æ®ä¸ºç©º" subTitle="è¯·é€‰æ‹©ç­çº§"></tm-result>
    <tm-float-button position="br" :btn="{ icon: 'tmicon-tag', linear: 'bottom', color: 'green' }"
      @click="showWin = true"></tm-float-button>
  </tm-app>
</template>
<script lang="ts" setup>
import { Dayjs } from "../../tmui/tool/dayjs/esm";
import {
  ref,
  reactive,
  nextTick,
  getCurrentInstance,
  onBeforeMount,
} from "vue";
import { useTmpiniaStore } from "@/tmui/tool/lib/tmpinia";
import GradeTarget from "@/api/apis/grade";
import { SpiAxios } from "@/service/spi/spi";
import storage from "@/service/storage/storage";
import * as dayjs from "@/tmui/tool/dayjs/esm/index";
import weekday from "@/tmui/tool/dayjs/esm/plugin/weekday/index";
import "@/tmui/tool/dayjs/esm/locale/zh-cn";
const DayJs = dayjs.default;
DayJs.extend(weekday);
DayJs.locale("zh-cn");
const store = useTmpiniaStore();
const { proxy, ctx } = getCurrentInstance();
const showWin = ref(false);
const select_grade = ref(null);
const app = ref<InstanceType<typeof tmApp> | null>(null);
const selectGrade = (grade) => {
  getList(grade.id);
  showWin.value = false;
};
const copy = (remind) => {
  uni.setClipboardData({
    data: remind,
    success: function () {
      console.log("å¤åˆ¶æˆåŠŸ");
    },
  });
};
const remind = (student, grade) => {
  let week = [
    { num: 0, name: "å‘¨ä¸€" },
    { num: 1, name: "å‘¨äºŒ" },
    { num: 2, name: "å‘¨ä¸‰" },
    { num: 3, name: "å‘¨å››" },
    { num: 4, name: "å‘¨äº”" },
    { num: 5, name: "å‘¨å…­" },
    { num: 6, name: "å‘¨æ—¥" },
  ].filter((e) => {
    return e.name == grade.week;
  })[0].num;
  let date = DayJs().weekday(week);
  let timeStr = "ä»Šå¤©";
  if (date.isAfter(DayJs())) {
    // ä»Šå¤©ä¹‹åŽ
    timeStr = ["ä»Šå¤©", "æ˜Žå¤©", "åŽå¤©"][date.date() - DayJs().date()];
  }
  const toast =
    student.petName +
    ((student.parent && student.parent.length) > 0 ? student.parent : "å¦ˆå¦ˆ") +
    "æ‚¨å¥½\nâ˜˜ï¸" +
    timeStr +
    "æœ‰å’±ä»¬å®è´çš„ä¹é«˜è¯¾ï¼Œè®°å¾—å‡†æ—¶åˆ°è¯¾å“ˆ[çŽ«ç‘°]\nâ°ä¸Šè¯¾æ—¶é—´ï¼š" +
    "" +
    date.format("MMæœˆDDæ—¥") +
    "(" +
    grade.week +
    ")" +
    grade.time +
    "\nðŸ ä¸Šè¯¾æ•™å®¤ï¼š" +
    grade.roomName +
    "\nðŸ‘¨â€ðŸ«æŽˆè¯¾è€å¸ˆï¼š" +
    grade.teacherName +
    "\næ¸©é¦¨æç¤ºï¼š\nâ‘ æ ¡åŒºæœ‰å¼€æ°´ï¼Œå¯ä»¥ä¸ºå®è´å¸¦ä¸Šæ°´æ¯\nâ‘¡æ ¡åŒºæœ‰å¼€ç©ºè°ƒï¼Œå¯ä¸ºå®è´å¸¦ä¸Šè–„å¤–å¥—\n";
  return toast;

};
/** å­¦ç”Ÿæ•°æ® */
const data_source = reactive({
  grade: {},
  data: [] as any,
});
const getList = (id: number) => {
  SpiAxios.create(GradeTarget.students({ id: id }))
    .http()
    .then((data) => {
      console.log(data);
      data_source.grade = data;
      data_source.data = data.students.map((e) => {
        e.remind = remind(e, data);
        return e;
      });
    })
    .catch((err) => {
      console.log(err);
    });
};
/** ç­çº§æ•°æ® */
const grade_source = reactive({
  data: [] as any,
});
const getGradeList = () => {
  const user = storage.get("user");
  if (!user) {
    uni.redirectTo({
      url: "/pages/account/login",
    });
  }
  SpiAxios.create(GradeTarget.grades({ userid: user.id }))
    .http()
    .then((data) => {
      console.log(data);
      grade_source.data = data;
    })
    .catch((err) => {
      console.log(err);
    });
};
getGradeList();
</script>