<template>
  <tm-app ref="app" color="grey-5">
    <tm-navbar title="å­¦å‘˜ç®¡ç†" :shadow="0" hide-home :followTheme="true">
      <template v-slot:right>
        <view class="flex flex-center flex-row">
          <tm-icon
            _class="px-24"
            :font-size="32"
            name="tmicon-menu"
            @click="showWin = true"
          ></tm-icon>
        </view>
      </template>
    </tm-navbar>
    <tm-card
      v-for="(student, index) in data_source.data"
      :key="index"
      :status="data_source.grade.name"
      :statusColor="store.tmStore.color"
      :title="student.name"
    >
      <template v-slot:content>
        <tm-sheet no-level :shadow="2" :round="3" :margin="[0, 10]">
          <tm-button
            class="copy-btn"
            :margin="[10, 10]"
            size="small"
            :shadow="0"
            label="åˆ°è¯¾æé†’"
            @click="remind(student, data_source.grade)"
          ></tm-button>
          <tm-more :height="120">
            <tm-text label="sfsdf"></tm-text>
          </tm-more>
        </tm-sheet>
        <view class="flex flex-row flex-row-center-end">
          <tm-button
            :margin="[24, 0]"
            label="ç¼–è¾‘"
            :font-size="24"
            :width="120"
            :height="50"
          ></tm-button>
          <tm-button
            color="white"
            label="åˆ é™¤"
            :font-size="24"
            :width="120"
            :height="50"
          ></tm-button>
        </view>
      </template>
    </tm-card>
    <tm-drawer ref="gradeDrawer" placement="right" v-model:show="showWin">
      <template v-slot:default>
        <tm-sheet>
          <tm-text
            :font-size="24"
            _class="font-weight-b"
            label="æˆ‘çš„ç­çº§"
          ></tm-text>
          <tm-divider></tm-divider>
          <tm-radio-group model="button" v-model="select_grade">
            <tm-radio
              :border="0"
              :round="3"
              v-for="(grade, index) in grade_source.data"
              :key="index"
              :value="grade.id"
              :label="grade.name"
              :fontSize="30"
              @change="selectGrade(grade)"
            ></tm-radio>
          </tm-radio-group>
        </tm-sheet>
      </template>
    </tm-drawer>
  </tm-app>
</template>
<script lang="ts" setup>
import {
  ref,
  reactive,
  nextTick,
  getCurrentInstance,
  onBeforeMount,
} from "vue";
import { useTmpiniaStore } from "@/tmui/tool/lib/tmpinia";
import GradeTarget from "@/api/apis/grade";
import { SpiAxios } from "@/service/spi/spi";
import storage from "@/service/storage/storage";
import * as dayjs from "@/tmui/tool/dayjs/esm/index";
const DayJs = dayjs.default;
const store = useTmpiniaStore();
const { proxy, ctx } = getCurrentInstance();
const showWin = ref(false);
const select_grade = ref(null);
const app = ref<InstanceType<typeof tmApp> | null>(null);
console.log(DayJs().day(5));
const selectGrade = (grade) => {
  getList(grade.id);
  showWin.value = false;
};
const remind = (student, grade) => {
  let week = grade.week;
  let weeknum = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"].filterMap(
    (e, i) => {
      if(e == week){
        return i
      }
    }
  );
  console.log(weeknum)
  let weekTimes = this.getDates();
  let date = new Date();
  let timeStr = "";
  let noonStr = "";
  if (date.getDay() == week.week) {
    timeStr = uni.$u.timeFormat(date, "mmæœˆddæ—¥");
    noonStr = "ä»Šå¤©";
  } else {
    noonStr = "æ˜Žå¤©";
    let result = weekTimes.filter((t) => t.getDay() == week.week);
    timeStr = uni.$u.timeFormat(result[0], "mmæœˆddæ—¥");
  }
  let isAm = date.getDay() == week.week ? "ä»Šå¤©" : "æ˜Žå¤©";
  this.toast =
    student.petName +
    ((student.parent && student.parent.length) > 0 ? student.parent : "å¦ˆå¦ˆ") +
    "æ‚¨å¥½\nâ˜˜ï¸" +
    noonStr +
    item.time.slice(0, 2) +
    "æœ‰å’±ä»¬å®è´çš„ä¹é«˜è¯¾ï¼Œè®°å¾—å‡†æ—¶åˆ°è¯¾å“ˆ[çŽ«ç‘°]\nâ°ä¸Šè¯¾æ—¶é—´ï¼š" +
    "" +
    timeStr +
    "(" +
    week.name +
    ")" +
    item.time +
    "\nðŸ ä¸Šè¯¾æ•™å®¤ï¼š" +
    item.room +
    "\nðŸ‘¨â€ðŸ«æŽˆè¯¾è€å¸ˆï¼š" +
    item.teacher +
    "\næ¸©é¦¨æç¤ºï¼š\nâ‘ è¯·ä½©æˆ´å£ç½©ï¼Œç­¾åˆ°è¿›åº—\nâ‘¡æ ¡åŒºæœ‰å¼€æ°´ï¼Œå¯ä»¥ä¸ºå®è´å¸¦ä¸Šæ°´æ¯\nâ‘¢æ ¡åŒºæœ‰å¼€ç©ºè°ƒï¼Œå¯ä¸ºå®è´å¸¦ä¸Šè–„å¤–å¥—\nâ€â€”â€”â€”â€”â€”â€”â€” â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nðŸ“–é”‹æ ¼ç»ƒå­—æ­£å¼ä¸Šçº¿å•¦[å“‡]\nðŸ‘‰äº”å²ä»¥ä¸Šçš„å®è´å‡å¯æŠ¥åå‚åŠ ä½“éªŒðŸ”¥ï¸\nâ˜ï¸é¢„å”®ä¼˜æƒ åé¢æœ‰é™ï¼Œå¿«å¿«æ‰¾æˆ‘æŠ¢è´­å§ðŸ–ï¸";
};
const dates = () => {
  var new_Date = new Date();
  var timesStamp = new_Date.getTime();
  var currenDay = new_Date.getDay();
  var dates = [];
  for (var i = 0; i < 7; i++) {
    dates.push(
      new Date(timesStamp + 24 * 60 * 60 * 1000 * (i - ((currenDay + 6) % 7)))
      // .toLocaleDateString()
      // .replace(/[å¹´æœˆ]/g, '-')
      // .replace(/[æ—¥ä¸Šä¸‹åˆ]/g, '')
    );
  }
  return dates;
};
/** å­¦ç”Ÿæ•°æ® */
const data_source = reactive({
  grade: {},
  data: [] as any,
});
const getList = (id: number) => {
  SpiAxios.create(GradeTarget.students({ id: id }))
    .http()
    .then((data) => {
      console.log(data);
      data_source.grade = data;
      data_source.data = data.students;
    })
    .catch((err) => {
      console.log(err);
    });
};
/** ç­çº§æ•°æ® */
const grade_source = reactive({
  data: [] as any,
});
const getGradeList = () => {
  const user = storage.get("user");
  SpiAxios.create(GradeTarget.grades({ userid: user.id }))
    .http()
    .then((data) => {
      console.log(data);
      grade_source.data = data;
    })
    .catch((err) => {
      console.log(err);
    });
};
getGradeList();
</script>